# 任务开发规范

本文档说明如何开发新的自动化任务脚本，确保代码风格统一、可独立调试。

## 文件结构

每个任务脚本应包含以下部分：

```python
"""
任务名称
任务描述

使用方法：
- 调试模式：修改 DEBUG_BROWSER_ID，直接运行此文件
- 正式调用：main.py 中调用 任务函数(driver, ...)
"""

import os
import sys
import time
import random
from typing import TYPE_CHECKING
from dataclasses import dataclass

if TYPE_CHECKING:
    from selenium.webdriver.remote.webdriver import WebDriver

# ==================== 路径设置 ====================

current_dir = os.path.dirname(os.path.abspath(__file__))
scripts_dir = os.path.dirname(current_dir)
project_root = os.path.dirname(os.path.dirname(scripts_dir))

# 脚本配置目录
脚本配置目录 = os.path.join(scripts_dir, "脚本配置")

for path in [current_dir, scripts_dir, project_root]:
    if path not in sys.path:
        sys.path.insert(0, path)


# ==================== 调试配置 ====================

DEBUG_BROWSER_ID = "你的浏览器ID"  # 修改为你的浏览器ID


# ==================== 任务配置 ====================

@dataclass
class 任务配置:
    """任务配置类"""
    参数1: int = 100
    参数2: str = "默认值"


# ==================== 主任务函数 ====================

def 任务函数(driver: "WebDriver", log_func=None, 配置: 任务配置 = None) -> bool:
    """
    任务主函数
    
    Args:
        driver: Selenium WebDriver
        log_func: 日志函数
        配置: 任务配置
    
    Returns:
        是否成功
    """
    def log(msg):
        if log_func:
            log_func(msg)
        else:
            print(f"[任务名] {msg}")
    
    if 配置 is None:
        配置 = 任务配置()
    
    # 任务逻辑...
    
    return True


# ==================== 调试模式 ====================

def _调试模式():
    """调试模式入口"""
    print("=" * 60)
    print("任务名称 - 调试模式")
    print("=" * 60)
    print(f"浏览器ID: {DEBUG_BROWSER_ID}")
    print()
    
    # 导入比特浏览器API
    try:
        from bitbrowser_api import bit_browser
    except ImportError:
        print("❌ 无法导入 bitbrowser_api")
        return
    
    # 1. 打开浏览器
    print("正在打开浏览器...")
    result = bit_browser.open_browser(DEBUG_BROWSER_ID)
    
    if not result.get("success"):
        print(f"❌ 打开浏览器失败: {result}")
        return
    
    data = result.get("data", {})
    debug_port = data.get("http")
    driver_path = data.get("driver")
    
    if not debug_port:
        print("❌ 未获取到调试端口")
        return
    
    print(f"✓ 浏览器已打开")
    print(f"  调试端口: {debug_port}")
    print(f"  驱动路径: {driver_path}")
    
    # 2. 连接 Selenium
    print("正在连接 Selenium...")
    try:
        from selenium import webdriver
        from selenium.webdriver.chrome.options import Options
        from selenium.webdriver.chrome.service import Service
        
        options = Options()
        options.add_experimental_option("debuggerAddress", debug_port)
        
        if driver_path:
            service = Service(driver_path)
            driver = webdriver.Chrome(service=service, options=options)
        else:
            driver = webdriver.Chrome(options=options)
        
        print(f"✓ Selenium 连接成功")
        print(f"  当前页面: {driver.title}")
        print()
        
    except Exception as e:
        print(f"❌ Selenium 连接失败: {e}")
        import traceback
        traceback.print_exc()
        return
    
    # 3. 执行任务
    print("-" * 60)
    print("开始执行任务...")
    print("-" * 60)
    
    # 调试配置
    测试配置 = 任务配置(
        参数1=50,
        参数2="测试"
    )
    
    成功 = 任务函数(driver, 配置=测试配置)
    
    print("-" * 60)
    if 成功:
        print("✓ 任务执行成功")
    else:
        print("✗ 任务执行失败")
    print("-" * 60)
    
    print()
    print("调试完成，浏览器保持打开状态")


# ==================== 入口 ====================

if __name__ == "__main__":
    _调试模式()
```

## 关键要点

### 1. 路径设置

```python
current_dir = os.path.dirname(os.path.abspath(__file__))
scripts_dir = os.path.dirname(current_dir)
project_root = os.path.dirname(os.path.dirname(scripts_dir))

for path in [current_dir, scripts_dir, project_root]:
    if path not in sys.path:
        sys.path.insert(0, path)
```

这样可以确保：
- 能导入同目录的其他模块（如 `自动化工具.py`）
- 能导入项目根目录的模块（如 `bitbrowser_api`）

### 2. 调试配置

```python
DEBUG_BROWSER_ID = "你的浏览器ID"
```

- 在比特浏览器中创建一个测试用的浏览器
- 复制浏览器ID到这里
- 直接运行脚本即可调试

### 3. 日志函数

```python
def log(msg):
    if log_func:
        log_func(msg)
    else:
        print(f"[任务名] {msg}")
```

- 正式调用时使用传入的 `log_func`
- 调试模式时直接 `print`

### 4. 配置类

使用 `@dataclass` 定义配置：

```python
@dataclass
class 任务配置:
    参数1: int = 100
    参数2: str = "默认值"
```

- 便于传递多个参数
- 有默认值，调用时可选

### 5. 连接比特浏览器

```python
result = bit_browser.open_browser(DEBUG_BROWSER_ID)
data = result.get("data", {})
debug_port = data.get("http")      # 调试端口，如 "127.0.0.1:9222"
driver_path = data.get("driver")   # ChromeDriver 路径
```

- `http` 是调试端口（不是 `debug_port`）
- `driver` 是 ChromeDriver 路径

### 6. Selenium 连接

```python
options = Options()
options.add_experimental_option("debuggerAddress", debug_port)

if driver_path:
    service = Service(driver_path)
    driver = webdriver.Chrome(service=service, options=options)
else:
    driver = webdriver.Chrome(options=options)
```

- 使用比特浏览器提供的 ChromeDriver
- 通过 `debuggerAddress` 连接已打开的浏览器

## 现有任务参考

| 文件 | 功能 | 主函数 |
|------|------|--------|
| `视频功能.py` | 搜索观看视频 | `视频功能(driver, log_func, 配置)` |
| `阅读.py` | 浏览首页/搜索 | `阅读(driver, log_func, 配置)` |
| `设置头像.py` | 检测/设置头像 | `设置头像(driver, log_func)` |
| `到首页.py` | 导航到首页 | `到首页(driver, log_func)` |
| `登录.py` | 账号登录 | `批量登录(log_func, client)` |

## 调试步骤

1. 修改 `DEBUG_BROWSER_ID` 为你的测试浏览器ID
2. 确保比特浏览器已启动
3. 直接运行脚本：`python 任务名.py`
4. 观察输出，调试问题
5. 调试完成后，浏览器保持打开，可继续手动测试

## 注意事项

1. **不要在调试模式关闭浏览器** - 调试完成后浏览器保持打开，方便继续测试
2. **使用中文函数名** - 除了 PyQt5 信号处理函数外，其他函数使用中文命名
3. **配置文件路径** - 所有配置文件放在 `脚本配置` 目录下
4. **错误处理** - 使用 try-except 包裹可能出错的代码，避免中断
5. **日志输出** - 关键步骤要输出日志，方便调试
