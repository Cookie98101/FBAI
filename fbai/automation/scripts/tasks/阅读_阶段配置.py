"""
阅读模块 - 阶段配置系统
根据账号创建天数自动调整任务参数
"""

from dataclasses import dataclass
from typing import Tuple
import random


@dataclass
class 阶段参数:
    """单个阶段的参数配置"""
    阶段编号: int
    天数范围: Tuple[int, int]  # (最小天数, 最大天数)
    任务数范围: Tuple[int, int]  # 每次会话的任务数
    单次阅读时长范围: Tuple[int, int]  # 秒
    帖子数范围: Tuple[int, int]
    首页比例: float  # 0-1
    搜索比例: float  # 0-1
    搜索次数范围: Tuple[int, int]
    
    # 阅读行为参数
    滚动速度范围: Tuple[int, int]  # 毫秒
    停留时间范围: Tuple[float, float]  # 秒
    鼠标移动间隔范围: Tuple[int, int]  # 秒
    帖子切换间隔范围: Tuple[int, int]  # 秒
    回滚概率范围: Tuple[int, int]  # 百分比
    点击图片概率范围: Tuple[int, int]  # 百分比
    播放视频概率范围: Tuple[int, int]  # 百分比
    视频播放时长范围: Tuple[int, int]  # 秒
    
    # 查看评论概率
    查看评论概率: float  # 0-1
    
    # 对帖子发布者的动作配额
    点赞数范围: Tuple[int, int]
    评论数范围: Tuple[int, int]
    私信数范围: Tuple[int, int]
    加好友数范围: Tuple[int, int]
    点击头像概率: float  # 0-1
    
    # 对评论用户的动作配额
    查看评论数范围: Tuple[int, int]
    点赞评论数范围: Tuple[int, int]
    回复评论数范围: Tuple[int, int]
    私信评论者数范围: Tuple[int, int]
    加好友评论者数范围: Tuple[int, int]
    访问主页数范围: Tuple[int, int]
    
    # 内容分配比例
    精准帖比例: float  # 0-1
    相关帖比例: float  # 0-1
    不相关帖比例: float  # 0-1
    
    # 最低完成要求
    最低时长: int  # 秒
    最低帖子数: int


# 定义6个阶段的配置（根据参数表）
阶段配置表 = [
    # 阶段1: 0-3天（极度保守）
    阶段参数(
        阶段编号=1,
        天数范围=(0, 3),
        任务数范围=(1, 2),
        单次阅读时长范围=(180, 360),  # 3-6分钟
        帖子数范围=(4, 7),
        首页比例=1.0,
        搜索比例=0.0,
        搜索次数范围=(0, 0),
        
        滚动速度范围=(250, 900),
        停留时间范围=(1.5, 6.0),
        鼠标移动间隔范围=(2, 10),
        帖子切换间隔范围=(5, 60),
        回滚概率范围=(5, 15),
        点击图片概率范围=(10, 25),
        播放视频概率范围=(15, 35),
        视频播放时长范围=(3, 20),
        
        查看评论概率=0.10,
        
        点赞数范围=(0, 1),
        评论数范围=(0, 0),
        私信数范围=(0, 0),
        加好友数范围=(0, 0),
        点击头像概率=0.0,
        
        查看评论数范围=(0, 2),
        点赞评论数范围=(0, 0),
        回复评论数范围=(0, 0),
        私信评论者数范围=(0, 0),
        加好友评论者数范围=(0, 0),
        访问主页数范围=(0, 0),
        
        精准帖比例=0.30,
        相关帖比例=0.40,
        不相关帖比例=0.30,
        
        最低时长=180,  # 3分钟
        最低帖子数=3
    ),
    
    # 阶段2: 4-7天（非常保守）
    阶段参数(
        阶段编号=2,
        天数范围=(4, 7),
        任务数范围=(1, 3),
        单次阅读时长范围=(180, 480),  # 3-8分钟
        帖子数范围=(5, 9),
        首页比例=0.95,
        搜索比例=0.05,
        搜索次数范围=(0, 1),
        
        滚动速度范围=(250, 900),
        停留时间范围=(1.5, 6.0),
        鼠标移动间隔范围=(2, 10),
        帖子切换间隔范围=(5, 60),
        回滚概率范围=(5, 15),
        点击图片概率范围=(10, 25),
        播放视频概率范围=(15, 35),
        视频播放时长范围=(3, 20),
        
        查看评论概率=0.20,
        
        点赞数范围=(0, 1),
        评论数范围=(0, 0),
        私信数范围=(0, 0),
        加好友数范围=(0, 0),
        点击头像概率=0.05,
        
        查看评论数范围=(1, 4),
        点赞评论数范围=(0, 1),
        回复评论数范围=(0, 0),
        私信评论者数范围=(0, 0),
        加好友评论者数范围=(0, 0),
        访问主页数范围=(0, 0),
        
        精准帖比例=0.40,
        相关帖比例=0.35,
        不相关帖比例=0.25,
        
        最低时长=180,  # 3分钟
        最低帖子数=4
    ),
    
    # 阶段3: 8-15天（保守）
    阶段参数(
        阶段编号=3,
        天数范围=(8, 15),
        任务数范围=(2, 4),
        单次阅读时长范围=(240, 600),  # 4-10分钟
        帖子数范围=(6, 11),
        首页比例=0.85,
        搜索比例=0.15,
        搜索次数范围=(0, 1),
        
        滚动速度范围=(250, 900),
        停留时间范围=(1.5, 6.0),
        鼠标移动间隔范围=(2, 10),
        帖子切换间隔范围=(5, 60),
        回滚概率范围=(5, 15),
        点击图片概率范围=(10, 25),
        播放视频概率范围=(15, 35),
        视频播放时长范围=(3, 20),
        
        查看评论概率=0.25,  # 从35%降低到25%
        
        点赞数范围=(1, 2),
        评论数范围=(0, 1),
        私信数范围=(0, 0),
        加好友数范围=(0, 0),
        点击头像概率=0.10,
        
        查看评论数范围=(2, 6),
        点赞评论数范围=(0, 1),
        回复评论数范围=(0, 0),
        私信评论者数范围=(0, 0),
        加好友评论者数范围=(0, 0),
        访问主页数范围=(0, 1),
        
        精准帖比例=0.50,
        相关帖比例=0.30,
        不相关帖比例=0.20,
        
        最低时长=240,  # 4分钟
        最低帖子数=5
    ),
    
    # 阶段4: 16-25天（中等）
    阶段参数(
        阶段编号=4,
        天数范围=(16, 25),
        任务数范围=(2, 5),
        单次阅读时长范围=(300, 720),  # 5-12分钟
        帖子数范围=(8, 13),
        首页比例=0.70,
        搜索比例=0.30,
        搜索次数范围=(1, 2),
        
        滚动速度范围=(250, 900),
        停留时间范围=(1.5, 6.0),
        鼠标移动间隔范围=(2, 10),
        帖子切换间隔范围=(5, 60),
        回滚概率范围=(5, 15),
        点击图片概率范围=(10, 25),
        播放视频概率范围=(15, 35),
        视频播放时长范围=(3, 20),
        
        查看评论概率=0.30,  # 从35%降低到30%
        
        点赞数范围=(1, 3),
        评论数范围=(0, 1),
        私信数范围=(0, 0),
        加好友数范围=(0, 1),
        点击头像概率=0.20,
        
        查看评论数范围=(4, 8),
        点赞评论数范围=(1, 2),
        回复评论数范围=(0, 1),
        私信评论者数范围=(0, 0),
        加好友评论者数范围=(0, 0),
        访问主页数范围=(1, 1),
        
        精准帖比例=0.55,
        相关帖比例=0.30,
        不相关帖比例=0.15,
        
        最低时长=300,  # 5分钟
        最低帖子数=6
    ),
    
    # 阶段5: 26-45天（活跃）
    阶段参数(
        阶段编号=5,
        天数范围=(26, 45),
        任务数范围=(3, 6),
        单次阅读时长范围=(240, 900),  # 4-15分钟
        帖子数范围=(9, 16),
        首页比例=0.55,
        搜索比例=0.45,
        搜索次数范围=(1, 3),
        
        滚动速度范围=(250, 900),
        停留时间范围=(1.5, 6.0),
        鼠标移动间隔范围=(2, 10),
        帖子切换间隔范围=(5, 60),
        回滚概率范围=(5, 15),
        点击图片概率范围=(10, 25),
        播放视频概率范围=(15, 35),
        视频播放时长范围=(3, 20),
        
        查看评论概率=0.35,  # 从45%降低到35%
        
        点赞数范围=(2, 4),
        评论数范围=(1, 2),
        私信数范围=(0, 1),
        加好友数范围=(0, 1),
        点击头像概率=0.30,
        
        查看评论数范围=(6, 12),
        点赞评论数范围=(1, 3),
        回复评论数范围=(1, 2),
        私信评论者数范围=(0, 1),
        加好友评论者数范围=(0, 1),
        访问主页数范围=(1, 2),
        
        精准帖比例=0.65,
        相关帖比例=0.25,
        不相关帖比例=0.10,
        
        最低时长=240,  # 4分钟
        最低帖子数=7
    ),
    
    # 阶段6: 46+天（成熟账号）
    阶段参数(
        阶段编号=6,
        天数范围=(46, 999999),
        任务数范围=(3, 7),
        单次阅读时长范围=(180, 1200),  # 3-20分钟
        帖子数范围=(10, 18),
        首页比例=0.45,
        搜索比例=0.55,
        搜索次数范围=(1, 4),
        
        滚动速度范围=(250, 900),
        停留时间范围=(1.5, 6.0),
        鼠标移动间隔范围=(2, 10),
        帖子切换间隔范围=(5, 60),
        回滚概率范围=(5, 15),
        点击图片概率范围=(10, 25),
        播放视频概率范围=(15, 35),
        视频播放时长范围=(3, 20),
        
        查看评论概率=0.40,  # 从45%降低到40%
        
        点赞数范围=(2, 5),
        评论数范围=(1, 3),
        私信数范围=(1, 2),
        加好友数范围=(1, 2),
        点击头像概率=0.40,
        
        查看评论数范围=(8, 15),
        点赞评论数范围=(2, 4),
        回复评论数范围=(1, 3),
        私信评论者数范围=(1, 2),
        加好友评论者数范围=(1, 2),
        访问主页数范围=(2, 3),
        
        精准帖比例=0.70,
        相关帖比例=0.20,
        不相关帖比例=0.10,
        
        最低时长=180,  # 3分钟
        最低帖子数=8
    ),
]


def 获取账号阶段(账号天数: int) -> 阶段参数:
    """
    根据账号天数获取对应的阶段配置
    
    Args:
        账号天数: 账号创建至今的天数
    
    Returns:
        对应阶段的参数配置
    """
    for 阶段 in 阶段配置表:
        最小天数, 最大天数 = 阶段.天数范围
        if 最小天数 <= 账号天数 <= 最大天数:
            return 阶段
    
    # 如果超出所有阶段，返回最后一个阶段（成熟账号）
    return 阶段配置表[-1]


def 生成随机配置(阶段: 阶段参数) -> dict:
    """
    根据阶段参数生成随机的具体配置
    
    Args:
        阶段: 阶段参数
    
    Returns:
        具体的配置字典
    """
    # 生成总时长
    总时长 = random.randint(*阶段.单次阅读时长范围)
    
    # 根据首页/搜索比例分配时间
    首页时长 = int(总时长 * 阶段.首页比例)
    搜索时长 = 总时长 - 首页时长
    
    return {
        '阶段编号': 阶段.阶段编号,
        '单次阅读时长': 总时长,
        '首页时长': 首页时长,
        '搜索时长': 搜索时长,
        '帖子数': random.randint(*阶段.帖子数范围),
        '使用搜索': random.random() < 阶段.搜索比例,
        '搜索次数': random.randint(*阶段.搜索次数范围),
        
        # 阅读行为
        '滚动速度': random.randint(*阶段.滚动速度范围),
        '停留时间': random.uniform(*阶段.停留时间范围),
        '鼠标移动间隔': random.randint(*阶段.鼠标移动间隔范围),
        '帖子切换间隔': random.randint(*阶段.帖子切换间隔范围),
        '回滚概率': random.randint(*阶段.回滚概率范围) / 100.0,
        '点击图片概率': random.randint(*阶段.点击图片概率范围) / 100.0,
        '播放视频概率': random.randint(*阶段.播放视频概率范围) / 100.0,
        '视频播放时长': random.randint(*阶段.视频播放时长范围),
        
        # 查看评论
        '查看评论概率': 阶段.查看评论概率,
        
        # 对帖子发布者的动作（严格配额）
        '点赞配额': random.randint(*阶段.点赞数范围),
        '评论配额': random.randint(*阶段.评论数范围),
        '私信配额': random.randint(*阶段.私信数范围),
        '加好友配额': random.randint(*阶段.加好友数范围),
        '点击头像概率': 阶段.点击头像概率,
        
        # 对评论用户的动作（严格配额）
        '查看评论配额': random.randint(*阶段.查看评论数范围),
        '点赞评论配额': random.randint(*阶段.点赞评论数范围),
        '回复评论配额': random.randint(*阶段.回复评论数范围),
        '私信评论者配额': random.randint(*阶段.私信评论者数范围),
        '加好友评论者配额': random.randint(*阶段.加好友评论者数范围),
        '访问主页配额': random.randint(*阶段.访问主页数范围),
        
        # 内容分配比例
        '精准帖比例': 阶段.精准帖比例,
        '相关帖比例': 阶段.相关帖比例,
        '不相关帖比例': 阶段.不相关帖比例,
        
        # 互动动作间隔时间（秒）
        '点赞间隔': (2, 10),
        '评论间隔': (20, 90),
        '私信间隔': (60, 180),
        '加好友间隔': (40, 120),
        '点赞评论间隔': (2, 8),
        '回复评论间隔': (20, 60),
        '私信评论者间隔': (60, 180),
        '访问主页间隔': (5, 20),
        
        # 最低要求
        '最低时长': 阶段.最低时长,
        '最低帖子数': 阶段.最低帖子数,
    }


def 获取账号天数(浏览器ID: str) -> int:
    """
    从数据库获取账号创建至今的天数
    
    Args:
        浏览器ID: 浏览器ID
    
    Returns:
        账号天数，如果获取失败返回0（使用阶段1）
    """
    try:
        from database.db import Database
        db = Database()
        
        # 从accounts表获取账号信息
        account = db.get_account(浏览器ID)
        if account and account.get('created_date'):
            from datetime import datetime
            创建日期 = datetime.fromisoformat(account['created_date'])
            今天 = datetime.now()
            天数 = (今天 - 创建日期).days
            return max(0, 天数)
    except Exception as e:
        print(f"[阶段配置] 获取账号天数失败: {e}")
    
    return 0  # 默认返回0天（阶段1）


# 测试代码
if __name__ == "__main__":
    print("=" * 60)
    print("阶段配置系统测试")
    print("=" * 60)
    
    测试天数列表 = [0, 2, 5, 10, 20, 30, 50, 100]
    
    for 天数 in 测试天数列表:
        阶段 = 获取账号阶段(天数)
        配置 = 生成随机配置(阶段)
        
        print(f"\n账号天数: {天数} 天")
        print(f"  阶段: {阶段.阶段编号}")
        print(f"  阅读时长: {配置['单次阅读时长']}秒 ({配置['单次阅读时长']//60}分钟)")
        print(f"  帖子数: {配置['帖子数']}")
        print(f"  使用搜索: {配置['使用搜索']}")
        print(f"  点赞数: {配置['点赞数']}")
        print(f"  评论数: {配置['评论数']}")
        print(f"  查看评论概率: {配置['查看评论概率']*100:.0f}%")
