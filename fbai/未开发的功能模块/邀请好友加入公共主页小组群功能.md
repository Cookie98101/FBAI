# 邀请好友加入公共主页小组群功能 - 需求文档

## 📋 基本信息

**版本**：v1.1  
**日期**：2026-02-02  

---

## 🎯 功能说明

小号邀请自己的好友加入指定小组，实现社群裂变。

**核心要点**：
- 批量邀请好友到小组
- 根据账号阶段控制邀请数量
- 首次需先加入小组，等待一段时间后才能邀请
- 集成人类行为模拟器

---

## 📥 任务参数

**UI 传入**：
- `account_id`: 账号ID
- `group_id`: 小组ID
- `group_name`: 小组名称
- `group_url`: 小组URL

---

## 🔄 执行流程

### 1. 检查是否已加入小组
**方法**：打开账号的小组列表页面（facebook.com/groups），检查目标小组是否在列表中

**判断逻辑**：
- 通过 `group_id` 或 `group_name` 匹配
- 如果找到 → 获取加入时间，继续步骤2
- 如果未找到 → 执行"首次加入小组流程"（见下方）

### 2. 首次加入小组流程（如果未加入）
```
1. 打开小组页面（group_url）
2. 浏览小组信息（滚动2次，停留10-20秒）
3. 随机点击1-2个帖子浏览（5-10秒/个）
4. 返回小组页面
5. 点击"加入小组"按钮（延迟3-8秒）
6. 等待2-3秒，检测是否成功
7. 加入后继续浏览20-40秒
8. 本次任务结束，不执行邀请
```

**注意**：
- ❌ 不需要回答入群问题
- ✅ 完全模拟真人行为

### 3. 检查加入时间间隔
**从小组列表获取加入时间**，计算距今时长：

| 账号阶段 | 要求等待时长 |
|---------|-------------|
| 1-2阶段 | 不执行邀请 |
| 3阶段 | 48小时 |
| 4阶段 | 36小时 |
| 5-6阶段 | 24小时 |

- 如果时长不足 → 跳过邀请，返回剩余等待时间
- 如果时长满足 → 继续步骤4

### 4. 检查阶段和限额
```
1. 获取账号当前阶段
2. 检查该阶段是否允许邀请（1-2阶段跳过）
3. 获取该阶段的单次邀请数量范围（min-max）
4. 查询今日已邀请总数（从 tasks 表统计）
5. 检查是否超过每日限额
6. 计算本次应邀请数量 = random(min, max)
```

### 5. 执行邀请
```
1. 进入小组页面
2. 点击"邀请好友"按钮
3. 等待好友列表弹窗加载
4. 滚动加载好友列表
5. 遍历好友，点击"邀请"按钮
6. 每邀请一个好友后智能延迟（根据阶段配置）
7. 达到本次邀请数量后停止
8. 关闭邀请弹窗
9. 记录到 tasks 表
```

---

## 📊 阶段配置

| 阶段 | 天数 | 加入后等待 | 每日限额 | 单次数量 | 单次延迟(秒) |
|------|------|-----------|---------|---------|-------------|
| 1阶段 | 0-3天 | - | 0 | - | - |
| 2阶段 | 4-7天 | - | 0 | - | - |
| 3阶段 | 8-15天 | 48小时 | 3 | 1-2 | 30-50 |
| 4阶段 | 16-25天 | 36小时 | 5 | 1-2 | 20-40 |
| 5阶段 | 26-45天 | 24小时 | 8 | 2-3 | 15-35 |
| 6阶段 | 46天+ | 24小时 | 10 | 2-4 | 15-30 |

**说明**：
- **加入后等待**：首次加入小组后，必须等待指定时长才能邀请
- **每日限额**：每个账号每天最多邀请的总人数
- **单次数量**：每次运行任务时邀请的人数范围（随机）
- **单次延迟**：每邀请一个好友后的延迟时间

---

## 🗄️ 数据库

**使用现有 tasks 表**：
- `task_type`: `'invite_friends_to_group'`
- `task_result`: `{"group_id": "xxx", "group_name": "xxx", "invited_count": 5}`

**统计今日邀请数**：
```sql
SELECT SUM(JSON_EXTRACT(task_result, '$.invited_count')) 
FROM tasks
WHERE account_id = ? 
  AND task_type = 'invite_friends_to_group'
  AND DATE(executed_at) = DATE('now')
```

---

## 💻 核心方法

### 主流程
```python
execute_invite_task(account_id, group_id, group_name, group_url)
```

### 关键方法
- `check_group_membership_from_list(group_id, group_name)` - 从小组列表检查是否已加入
- `get_join_time_from_list(group_id)` - 从小组列表获取加入时间
- `join_group_naturally(group_url)` - 首次加入小组（模拟真人）
- `get_required_wait_hours(stage)` - 获取该阶段要求的等待时长
- `check_daily_quota(account_id)` - 检查今日已邀请数量
- `invite_friends(count)` - 执行邀请操作

---

## ⚠️ 异常处理

1. **未加入小组** → 执行加入流程，本次任务结束
2. **加入时间不足** → 跳过邀请，返回剩余等待时间
3. **达到每日限额** → 停止邀请
4. **好友列表加载失败** → 重试3次
5. **达到Facebook限制** → 停止该账号，记录日志

---

## 🔗 集成

### 账号阶段管理
```python
from automation.scripts.tasks.阅读_阶段配置 import 获取账号天数, 获取账号阶段

账号天数 = 获取账号天数(browser_id)
阶段配置 = 获取账号阶段(账号天数)
当前阶段 = 阶段配置.阶段编号  # 1-6
```

### 人类行为模拟器
```python
from 人类行为模拟器_v3_个性化 import 人类行为模拟器

模拟器 = 人类行为模拟器(driver, 账号档案=档案)
模拟器.人类化点击(button)
模拟器.智能延迟(15, 30)
模拟器.人类化滚动(scroll_times=2)
```

---

## 🎯 关键要点

1. ✅ **首次加入小组后不能立即邀请**，必须等待（3阶段48h，4阶段36h，5-6阶段24h）
2. ✅ **通过小组列表判断是否已加入**，无需额外数据库表
3. ✅ **从小组列表获取加入时间**，用于计算等待时长
4. ✅ **加入小组流程完全模拟真人**（浏览、点击帖子、延迟）
5. ✅ **不需要回答入群问题**
6. ✅ **限额非常保守**，避免触发风控（最高10人/天）
7. ✅ **小组ID和名称由UI提供**，无需解析URL
