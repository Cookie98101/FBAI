# 从小组成员添加好友功能 - 需求文档

## 📋 基本信息

**版本**：v2.0  
**日期**：2026-02-03  

---

## 🎯 功能说明

小号从当前小组成员列表中添加好友，扩展社交网络。

**核心要点**：
- 集成到小组互动模块，不单独运行
- 10%触发概率，50%只看不加
- 批量去重，全局唯一
- 浏览主页后添加

---

## 📥 任务参数

**由小组互动加权模块传入**：


---

## 🔄 执行流程

```
小组互动（浏览、点赞、评论）
↓
10%概率触发：点击"成员"标签
↓
滚动浏览成员列表
↓
提取20-30个成员ID
↓
批量数据库去重（全局）
↓
50%概率判断：
  - 只浏览，不加人
  - 从可用用户中随机选1-2个
↓
对每个用户：
  1. 点击头像
  2. 浏览主页5-10秒
  3. 滚动1-2次
  4. 点击"添加好友"
  5. 保存数据库
  6. 调用统计API
  7. 返回成员列表
↓
返回小组
```

---

## 📊 核心配置

### 触发条件
- 触发概率：10%
- 只看不加：50%
- 实际添加：5%（10% × 50%）
- 小组加入：≥7天
- 账号阶段：≥3阶段

### 每日限额
| 阶段 | 天数 | 每日限额 |
|------|------|---------|
| 3阶段 | 8-15天 | 5人 |
| 4阶段 | 16-25天 | 8人 |
| 5阶段 | 26-45天 | 12人 |
| 6阶段 | 46天+ | 15人 |

---

## 🗄️ 数据库

### friend_requests 表

```sql
CREATE TABLE IF NOT EXISTS friend_requests (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    account_id INTEGER NOT NULL,
    target_user_id TEXT NOT NULL,
    target_user_name TEXT,
    target_profile_url TEXT,
    source_type TEXT DEFAULT 'group_member',
    source_group_id TEXT,
    status TEXT DEFAULT 'pending',
    requested_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(account_id, target_user_id)
);

CREATE INDEX idx_target_user ON friend_requests(target_user_id, status);
```

### 批量去重查询

```sql
SELECT DISTINCT target_user_id 
FROM friend_requests 
WHERE target_user_id IN (?, ?, ?, ...)
  AND status IN ('pending', 'accepted')
```

**规则**：每个用户只允许1个账号营销（全局去重）

---

## 📊 统计API

### 接口

```python
POST /api/add-friend-stat

请求：
{
  "account_id": "account_001",
  "target_user_id": "user_123456",
  "source_type": "group_member",
  "timestamp": "2026-02-03T10:30:00"
}

响应：
{
  "success": true,
  "today_total": 5,
  "remaining_quota": 10
}
```

**调用时机**：每次点击"添加好友"按钮后

---

## 💻 核心方法

```python
# 主流程
execute_group_interaction_with_add_friend(account_id, group_id, group_url)

# 关键方法
should_view_members()  # 10%概率
should_add_friends()   # 50%概率
batch_filter_available_users(user_ids)  # 批量去重
call_add_friend_stat_api(account_id, user_id, source_type)  # 统计
```

---

## 🎯 关键要点

1. ✅ 集成到小组互动模块
2. ✅ 10%触发，50%只看不加，实际5%添加
3. ✅ 批量提取ID后去重（先提取20-30个，批量查询，再选择1-2个）
4. ✅ 全局去重：每个用户只被1个账号营销
5. ✅ 浏览主页5-10秒后再添加
6. ✅ 调用统计API记录
7. ✅ 小组加入≥7天才触发

---

## ⚠️ 异常处理

1. 小组加入<7天 → 不触发
2. 达到每日限额 → 不触发
3. 用户已被添加 → 跳过
4. 添加按钮未找到 → 跳过
5. 达到Facebook限制 → 停止账号

---

## 🔗 集成

```python
from automation.scripts.tasks.阅读_阶段配置 import 获取账号天数, 获取账号阶段
from 人类行为模拟器_v3_个性化 import 人类行为模拟器

# 在小组互动模块中调用
if should_view_members() and should_add_friends():
    add_friends_from_member_list(account_id, group_id, group_url)
```

---

**安全系数**：⭐⭐⭐⭐⭐（5星）

**风控策略**：有掩护行为、低频触发、50%只看不加、限额保守、全局去重
