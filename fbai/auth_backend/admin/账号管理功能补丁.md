# 账号管理功能补丁说明

## 需要在 index.html 中添加的内容

### 1. 在导航栏添加账号管理按钮

在第597行附近，添加：

```html
<button class="nav-btn" onclick="showSection('accounts')"><i class="fas fa-key"></i>账号管理</button>
```

### 2. 在主内容区添加账号管理界面

在用户管理section之后，添加：

```html
<!-- 账号管理 -->
<div id="accounts" class="section">
    <h2><i class="fas fa-key"></i>账号管理</h2>
    <div style="margin-bottom: 20px;">
        <button class="btn" onclick="showAddAccountDialog()"><i class="fas fa-plus"></i>添加账号</button>
        <button class="btn" onclick="loadAccounts()"><i class="fas fa-sync-alt"></i>刷新列表</button>
    </div>
    
    <table class="table" id="accountsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>C_User</th>
                <th>密码</th>
                <th>2FA</th>
                <th>邮箱</th>
                <th>状态</th>
                <th>分配给</th>
                <th>描述</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="10" style="text-align: center; padding: 40px;">
                    点击"刷新列表"加载账号数据
                </td>
            </tr>
        </tbody>
    </table>
</div>
```

### 3. 添加添加账号对话框

在HTML末尾，添加：

```html
<!-- 添加账号对话框 -->
<div id="addAccountDialog" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeAddAccountDialog()">&times;</span>
        <h2><i class="fas fa-key"></i>添加账号</h2>
        <form id="addAccountForm">
            <div class="form-group">
                <label>账号数据（格式：c_user|密码|2FA|邮箱|cookie|token）:</label>
                <textarea id="accountData" rows="3" required placeholder="例如：123456789|mypassword|ABCD1234|user@example.com||"></textarea>
            </div>
            <div class="form-group">
                <label>描述:</label>
                <input type="text" id="accountDescription" placeholder="例如：主账号">
            </div>
            <button type="submit" class="btn"><i class="fas fa-save"></i>添加</button>
        </form>
    </div>
</div>

<!-- 分配账号对话框 -->
<div id="assignAccountDialog" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeAssignAccountDialog()">&times;</span>
        <h2><i class="fas fa-user-plus"></i>分配账号</h2>
        <form id="assignAccountForm">
            <input type="hidden" id="assignAccountId">
            <div class="form-group">
                <label>选择用户:</label>
                <select id="assignUserId" required>
                    <option value="">请选择用户</option>
                </select>
            </div>
            <button type="submit" class="btn"><i class="fas fa-check"></i>确认分配</button>
        </form>
    </div>
</div>
```

### 4. 添加CSS样式

在style标签中添加：

```css
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 30px;
    border-radius: 10px;
    width: 80%;
    max-width: 600px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: #000;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.status-available {
    background-color: #d4edda;
    color: #155724;
}

.status-assigned {
    background-color: #fff3cd;
    color: #856404;
}
```

### 5. 添加JavaScript函数

在script标签中添加：

```javascript
// 账号管理相关函数
async function loadAccounts() {
    const result = await apiCall('admin.php', { action: 'list_accounts' });
    
    if (result.status === 'success') {
        const accounts = result.data;
        const tbody = document.querySelector('#accountsTable tbody');
        
        if (accounts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center;">暂无账号数据</td></tr>';
            return;
        }
        
        tbody.innerHTML = accounts.map(account => `
            <tr>
                <td>${account.id}</td>
                <td>${account.c_user}</td>
                <td>${account.password ? '●●●●●●' : '-'}</td>
                <td>${account.two_fa ? '●●●●' : '-'}</td>
                <td>${account.email || '-'}</td>
                <td>
                    <span class="status-badge status-${account.status}">
                        ${account.status === 'available' ? '可用' : '已分配'}
                    </span>
                </td>
                <td>${account.assigned_username || '-'}</td>
                <td>${account.description || '-'}</td>
                <td>${account.created_at}</td>
                <td>
                    ${account.status === 'available' ? 
                        `<button class="btn-small" onclick="showAssignDialog(${account.id})">分配</button>` :
                        `<button class="btn-small" onclick="unassignAccount(${account.id})">取消分配</button>`
                    }
                    <button class="btn-small btn-danger" onclick="deleteAccount(${account.id})">删除</button>
                </td>
            </tr>
        `).join('');
    } else {
        alert('加载失败: ' + result.message);
    }
}

function showAddAccountDialog() {
    document.getElementById('addAccountDialog').style.display = 'block';
}

function closeAddAccountDialog() {
    document.getElementById('addAccountDialog').style.display = 'none';
    document.getElementById('addAccountForm').reset();
}

function showAssignDialog(accountId) {
    document.getElementById('assignAccountId').value = accountId;
    document.getElementById('assignAccountDialog').style.display = 'block';
    loadUsersForAssign();
}

function closeAssignAccountDialog() {
    document.getElementById('assignAccountDialog').style.display = 'none';
    document.getElementById('assignAccountForm').reset();
}

async function loadUsersForAssign() {
    const result = await apiCall('admin.php', { action: 'list_users' });
    
    if (result.status === 'success') {
        const users = result.data;
        const select = document.getElementById('assignUserId');
        
        select.innerHTML = '<option value="">请选择用户</option>' +
            users.map(user => `<option value="${user.id}">${user.username} (${user.email})</option>`).join('');
    }
}

document.getElementById('addAccountForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const accountData = document.getElementById('accountData').value;
    const description = document.getElementById('accountDescription').value;
    
    const result = await apiCall('admin.php', {
        action: 'add_account',
        account_data: accountData,
        description: description
    });
    
    if (result.status === 'success') {
        alert('账号添加成功');
        closeAddAccountDialog();
        loadAccounts();
    } else {
        alert('添加失败: ' + result.message);
    }
});

document.getElementById('assignAccountForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const accountId = document.getElementById('assignAccountId').value;
    const userId = document.getElementById('assignUserId').value;
    
    if (!userId) {
        alert('请选择用户');
        return;
    }
    
    const result = await apiCall('admin.php', {
        action: 'assign_account',
        account_id: accountId,
        user_id: userId
    });
    
    if (result.status === 'success') {
        alert('分配成功');
        closeAssignAccountDialog();
        loadAccounts();
    } else {
        alert('分配失败: ' + result.message);
    }
});

async function unassignAccount(accountId) {
    if (!confirm('确定要取消分配此账号吗？')) return;
    
    const result = await apiCall('admin.php', {
        action: 'unassign_account',
        account_id: accountId
    });
    
    if (result.status === 'success') {
        alert('取消分配成功');
        loadAccounts();
    } else {
        alert('操作失败: ' + result.message);
    }
}

async function deleteAccount(accountId) {
    if (!confirm('确定要删除此账号吗？此操作不可恢复！')) return;
    
    const result = await apiCall('admin.php', {
        action: 'delete_account',
        account_id: accountId
    });
    
    if (result.status === 'success') {
        alert('删除成功');
        loadAccounts();
    } else {
        alert('删除失败: ' + result.message);
    }
}

// 在showSection函数中添加
if (sectionId === 'accounts') {
    loadAccounts();
}
```

## 完成！

按照以上步骤修改 `index.html` 文件即可添加账号管理功能。
